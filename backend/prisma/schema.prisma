// Q-Ease Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String?
  firstName      String
  lastName       String
  phoneNumber    String?
  organisationId String?
  roleId         String
  isVerified     Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organisation  Organisation?  @relation(fields: [organisationId], references: [id])
  roleModel     RoleModel      @relation(fields: [roleId], references: [id])
  userTokens    Token[]        @relation("UserTokens")
  notifications Notification[]
  calledTokens  Token[]        @relation("TokenCaller")
  
  // Lineage Security
  creatorId     String?
  creator       User?          @relation("UserLineage", fields: [creatorId], references: [id])
  createdUsers  User[]         @relation("UserLineage")
}

// Role model
model RoleModel {
  id          String   @id @default(cuid())
  name        String   @unique // SUPER_ADMIN, ORGANISATION_ADMIN, STAFF, USER
  description String?
  permissions Json? // Store permissions as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

// Organisation model
model Organisation {
  id           String   @id @default(cuid())
  code         String   @unique // 6-digit unique code
  name         String
  description  String?
  address      String?
  city         String?
  state        String?
  country      String?
  latitude     Float?
  longitude    Float?
  contactEmail String?
  contactPhone String?
  logoUrl      String?
  isVerified   Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  users         User[]
  queues        Queue[]
  tokens        Token[]
  notifications Notification[]
  analytics     Analytics[]
}



// Queue model
model Queue {
  id             String   @id @default(cuid())
  organisationId String
  name           String // Name of the queue (e.g., "Cashier", "Help Desk")
  description    String?
  maxTokens      Int? // Max number of tokens allowed per day
  averageTime    Int? // Average service time in minutes
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  tokens       Token[]
  analytics    Analytics[]
}

// Token model
model Token {
  id             String        @id @default(cuid())
  tokenId        String // Unique token identifier (e.g., A001, B023)
  queueId        String
  userId         String?
  organisationId String
  status         TokenStatus   @default(PENDING)
  priority       TokenPriority @default(NORMAL)
  position       Int? // Current position in queue
  estimatedTime  DateTime? // Estimated service time
  issuedAt       DateTime      @default(now())
  calledAt       DateTime?
  servedAt       DateTime?
  cancelledAt    DateTime?
  callerId       String? // Staff member who called the token
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  queue        Queue        @relation(fields: [queueId], references: [id], onDelete: Cascade)
  tokenUser    User?        @relation("UserTokens", fields: [userId], references: [id])
  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  caller       User?        @relation("TokenCaller", fields: [callerId], references: [id])
}

// Token status enumeration
enum TokenStatus {
  PENDING
  CALLED
  SERVED
  CANCELLED
  MISSED
  ABANDONED
}

// Token priority enumeration
enum TokenPriority {
  NORMAL
  PRIORITY
  EMERGENCY
}

// Notification model
model Notification {
  id             String           @id @default(cuid())
  userId         String
  organisationId String?
  title          String
  message        String
  type           NotificationType
  data           Json? // Additional data for the notification
  isRead         Boolean          @default(false)
  sentAt         DateTime?        @default(now())
  deliveredAt    DateTime?
  clickedAt      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation Organisation? @relation(fields: [organisationId], references: [id])
}

// Notification type enumeration
enum NotificationType {
  TOKEN_ISSUED
  TOKEN_CALLED
  TOKEN_REMINDER
  QUEUE_STATUS_UPDATE
  SYSTEM_ALERT
  PROMOTIONAL
}

// Analytics model
model Analytics {
  id             String     @id @default(cuid())
  organisationId String
  queueId        String?
  metricType     MetricType
  metricValue    Float
  date           DateTime   @default(now())
  metadata       Json? // Additional analytics data

  // Relations
  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  queue        Queue?       @relation(fields: [queueId], references: [id], onDelete: SetNull)
}

// Metric type enumeration
enum MetricType {
  AVERAGE_WAIT_TIME
  QUEUE_LENGTH
  SERVICE_RATE
  NO_SHOW_RATE
  ABANDONMENT_RATE
  CUSTOMER_SATISFACTION
  STAFF_EFFICIENCY
  PEAK_HOURS
}
